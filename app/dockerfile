# 1. Base Image: Use slim for smaller image size
FROM python:3.11-slim

# 2. Environment Variables
# PYTHONUNBUFFERED: Ensures logs are streamed immediately to container logs
# PYTHONDONTWRITEBYTECODE: Prevents .pyc files from bloating the image
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# 3. Set Working Directory
WORKDIR /app

# 4. Security: Create a non-root user
# Running as root is a security risk. We create a system user 'appuser'.
RUN addgroup --system appgroup && \
    adduser --system --ingroup appgroup appuser

# 5. Install Dependencies
# We copy requirements FIRST to leverage Docker layer caching.
# If you change code but not requirements, this step is skipped (fast build).
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 6. Copy Application Code
# We use '--chown' to ensure the non-root user owns the files.
# We copy from the local 'src' folder to the container's '/app' folder.
COPY --chown=appuser:appgroup ./ .

# 7. Switch User
USER appuser

# 8. Run the application
CMD ["python", "benchmark.py"]

# command to run from shell
# docker run --rm --env-file ../.env -e DB_HOST=host.docker.internal my-benchmark